# Base configuration shared between environments
main = ".open-next/worker.js"

compatibility_date = "2025-04-02"
compatibility_flags = ["nodejs_compat"]

# Worker size and performance optimizations 
find_additional_modules = true
preserve_file_names = true
minify = true # Enable minification globally

assets = { directory = ".open-next/assets", binding = "ASSETS" }

[observability]
enabled = true
logs.invocation_logs = true

# Service binding for worker self-reference (required for OpenNext)
[[services]]
binding = "WORKER_SELF_REFERENCE"
service = "allthingslinux-production"
environment = "production"

# R2 Bucket for Next.js incremental cache
[[r2_buckets]]
binding = "NEXT_INC_CACHE_R2_BUCKET"
bucket_name = "allthingslinux-cache-production"
preview_bucket_name = "allthingslinux-cache-dev"

# Production environment
[env.production]
name = "allthingslinux-production"
route = { pattern = "allthingslinux.org/*", custom_domain = true }
workers_dev = false  # Disable *.workers.dev subdomain
minify = true       # Minify worker code

# Services for production
[[env.production.services]]
binding = "WORKER_SELF_REFERENCE"
service = "allthingslinux-production"

# Public env vars (available to browser)
[env.production.vars]
NEXT_PUBLIC_URL = "https://allthingslinux.org"
NEXT_PUBLIC_API_URL = "https://allthingslinux.org/api"
NEXT_PUBLIC_GITHUB_REPO_OWNER = "allthingslinux"
NEXT_PUBLIC_GITHUB_REPO_NAME = "applications"
NODE_ENV = "production"

# For private env vars (not exposed to browser), set in Cloudflare dashboard:
# - GITHUB_TOKEN
# - MONDAY_API_KEY
# - MONDAY_BOARD_ID
# - DISCORD_WEBHOOK_URL

# Development environment (workers.dev subdomain)
[env.development]
name = "allthingslinux-development"
workers_dev = true   # Enable *.workers.dev subdomain for testing
minify = true      # Enable minification for development too

# Services for development
[[env.development.services]]
binding = "WORKER_SELF_REFERENCE"
service = "allthingslinux-development"

# Public env vars (available to browser)
[env.development.vars]
NEXT_PUBLIC_URL = "https://allthingslinux-development.allthingslinux.workers.dev"
NEXT_PUBLIC_API_URL = "https://allthingslinux-development.allthingslinux.workers.dev/api"
NEXT_PUBLIC_GITHUB_REPO_OWNER = "allthingslinux"
NEXT_PUBLIC_GITHUB_REPO_NAME = "applications"
NODE_ENV = "production"

# Local development environment
[env.local]
name = "allthingslinux-local"
workers_dev = true
minify = false

# Services for local development
[[env.local.services]]
binding = "WORKER_SELF_REFERENCE"
service = "allthingslinux-local"

# Public env vars (available to browser)
[env.local.vars]
NEXT_PUBLIC_URL = "http://localhost:8788"
NEXT_PUBLIC_API_URL = "http://localhost:8788/api"
NEXT_PUBLIC_GITHUB_REPO_OWNER = "allthingslinux"
NEXT_PUBLIC_GITHUB_REPO_NAME = "applications"
NODE_ENV = "development"

# For local development private env vars, see .dev.vars file

# Define KV Namespaces (if you need them)
# kv_namespaces = [
#   { binding = "MY_KV", id = "xxx", preview_id = "xxx" }
# ]

# Define D1 Databases (if you need them)
# [[d1_databases]]
# binding = "DB"
# database_name = "my-database"
# database_id = "xxx"

