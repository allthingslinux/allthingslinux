import * as fs from 'fs';
import * as path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

// Get the current file's directory
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');

/**
 * Process markdown content by removing HTML comments and headers
 */
function processMarkdownContent(content) {
  // Remove header content before "Code of Conduct"
  const contentStartIndex = content.indexOf('# Code of Conduct');
  if (contentStartIndex !== -1) {
    content = content.slice(contentStartIndex);
  }

  // Remove HTML comments and table of contents section
  content = content.replace(/<!--[\s\S]*?-->/g, '');
  const tocStart = content.indexOf('**Table of Contents**');
  const tocEnd = content.indexOf('## Preface');

  if (tocStart !== -1 && tocEnd !== -1) {
    content = content.slice(0, tocStart) + content.slice(tocEnd);
  }

  // Remove everything after "Above all, exercise good judgment and common sense."
  const endIndex = content.indexOf(
    'Above all, exercise good judgment and common sense.'
  );
  if (endIndex !== -1) {
    content = content.slice(
      0,
      endIndex + 'Above all, exercise good judgment and common sense.'.length
    );
  }

  return content.trim();
}

// Get the processed content
const readmePath = path.join(rootDir, 'code-of-conduct', 'README.md');
let readmeContent;
let lastUpdated;

try {
  // Read and process the README.md content
  readmeContent = processMarkdownContent(fs.readFileSync(readmePath, 'utf8'));

  // Get the last updated date
  const gitCommand = `git -C ${path.join(
    rootDir,
    'code-of-conduct'
  )} log -1 --format=%cd --date=format:'%B %d, %Y' -- README.md`;

  lastUpdated = execSync(gitCommand).toString().trim();

  // If empty (no commits yet), use a fallback
  if (!lastUpdated) {
    lastUpdated = 'Not available';
  }
} catch (error) {
  console.error('Error processing code of conduct:', error);
  readmeContent = '# Code of Conduct\n\nError loading code of conduct.';
  lastUpdated = 'Not available';
}

// Escape special characters in the content to make it safe for inserting into JS template literals
readmeContent = readmeContent.replace(/`/g, '\\`').replace(/\$/g, '\\$');

// Create a TypeScript file with the content as a constant
const tsContent = `/**
 * This file is auto-generated from scripts/generate-code-of-conduct.mjs
 * Do not edit this file directly!
 */

/**
 * The code of conduct content as a markdown string
 */
export const CODE_OF_CONDUCT_CONTENT = \`${readmeContent}\`;

/**
 * The date when the code of conduct was last updated
 */
export const LAST_UPDATED = '${lastUpdated}';
`;

// Ensure the lib directory exists
const libDir = path.join(rootDir, 'lib');
if (!fs.existsSync(libDir)) {
  fs.mkdirSync(libDir, { recursive: true });
}

// Write the TypeScript file
fs.writeFileSync(path.join(libDir, 'code-of-conduct.ts'), tsContent);

// Also write to JSON file for backwards compatibility
fs.writeFileSync(
  path.join(rootDir, 'public', 'code-of-conduct.json'),
  JSON.stringify(
    {
      content: readmeContent,
      lastUpdated: lastUpdated,
    },
    null,
    2
  )
);

console.log('âœ… Code of conduct TypeScript file generated successfully');
